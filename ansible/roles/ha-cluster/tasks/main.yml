---
- name: Enable HA repository
  command: dnf config-manager --set-enabled highavailability
  changed_when: true

- name: Enable CRB repository
  command: dnf config-manager --set-enabled crb
  changed_when: true

- name: Update DNF cache
  dnf:
    update_cache: yes

- name: Install HA packages
  dnf:
    name:
      - pacemaker
      - corosync
      - pcs
      - fence-agents-all
      - resource-agents
    state: present

- name: Allow HA in firewall
  firewalld:
    service: high-availability
    permanent: yes
    state: enabled
    immediate: yes

- name: Start pcsd
  systemd:
    name: pcsd
    state: started
    enabled: yes

- name: Set hacluster password
  user:
    name: hacluster
    password: "{{ 'hacluster' | password_hash('sha512') }}"

- name: Wait for pcsd
  wait_for:
    port: 2224
    delay: 5
    timeout: 60

- name: Authenticate nodes (node01 only)
  command: pcs host auth node01 node02 -u hacluster -p hacluster
  when: inventory_hostname == 'node01'
  run_once: true
  failed_when: false
  retries: 3
  delay: 5

- name: Check cluster status
  command: pcs cluster status
  register: cluster_status
  failed_when: false
  changed_when: false

- name: Create cluster
  command: >
    pcs cluster setup cerberus-cluster
    node01 addr=192.168.56.21
    node02 addr=192.168.56.22
    --start --enable --force
  when:
    - inventory_hostname == 'node01'
    - cluster_status.rc != 0
  run_once: true

- name: Wait for sync
  pause:
    seconds: 10
  when: 
    - inventory_hostname == 'node01'
    - cluster_status.rc != 0

- name: Start cluster
  command: pcs cluster start --all
  when: inventory_hostname == 'node01'
  run_once: true
  failed_when: false

- name: Enable cluster
  command: pcs cluster enable --all
  when: inventory_hostname == 'node01'
  run_once: true
  failed_when: false

- name: Disable STONITH
  command: pcs property set stonith-enabled=false
  when: inventory_hostname == 'node01'
  run_once: true
  failed_when: false

- name: Set quorum policy
  command: pcs property set no-quorum-policy=ignore
  when: inventory_hostname == 'node01'
  run_once: true
  failed_when: false
